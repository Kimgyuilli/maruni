# MARUNI 프로젝트 전체 개발 계획서

## 📋 프로젝트 개요

**MARUNI**는 노인들의 외로움과 우울증 문제 해결을 위한 **SMS 기반 AI 돌봄 서비스**입니다.
매일 정기적으로 안부 문자를 보내고, AI를 통해 응답을 분석하여 이상징후를 감지하며, 필요시 보호자에게 알림을 전송하는 노인 돌봄 플랫폼입니다.

### 🎯 핵심 가치 제안
- **능동적 소통**: 매일 아침 9시 안부 문자 자동 발송
- **AI 기반 분석**: 문자 응답을 통한 감정 상태 및 이상징후 감지
- **보호자 연동**: 긴급 상황 시 보호자/관리자에게 실시간 알림
- **건강 모니터링**: 지속적인 대화를 통한 건강 상태 추적

---

## 🏗️ 현재 구현 상태 (2025-09-12 기준)

### ✅ 완료된 모듈 (Foundation Layer)
| 모듈 | 완성도 | 설명 |
|------|--------|------|
| **Global Architecture** | 100% | 응답 래핑, 예외 처리, Swagger 문서화 |
| **Infrastructure Setup** | 100% | Docker, PostgreSQL, Redis 환경 |
| **Security System** | 100% | JWT 기반 인증, Spring Security 필터 체인 |
| **Member Domain** | 95% | 회원가입, 인증, CRUD 기능 + 테스트 완료 |
| **Auth Domain** | 90% | JWT 토큰 발급/검증, 로그인/로그아웃 + 테스트 완료 |

### ⚠️ 부분 구현된 모듈
| 모듈 | 완성도 | 현재 상태 | 필요 작업 |
|------|--------|-----------|----------|
| **SMS Domain** | 30% | Entity/VO/기본 테스트만 존재 | TDD로 Service, Repository, Controller 구현 |

### ❌ 미구현 모듈 (Business Logic Layer)
- **AI Conversation Domain**: AI 대화 처리 시스템
- **Health Monitoring Domain**: 건강 상태 분석 및 추적
- **Guardian Alert Domain**: 보호자 알림 시스템
- **Scheduler System**: 정기 메시지 발송 스케줄러
- **Analytics Domain**: 대화 분석 및 리포팅

---

## 🛠️ 확정 기술 스택

### Backend Core
```
- Java 21 + Spring Boot 3.5.x
- Spring Security 6 (JWT 인증)
- Spring Data JPA + Hibernate
- PostgreSQL (메인 데이터)
- Redis (캐싱, 세션)
- Docker + Docker Compose
```

### External APIs
```
- OpenAI GPT-4o API (AI 대화 처리)
- Twilio API (SMS 발송/수신)
- 이메일 API (향후 확장)
```

### Development Approach
```
- TDD (Test-Driven Development) 철저히 적용
- DDD (Domain-Driven Design) 아키텍처 유지
- 각 기능별 테스트 우선 작성 → 구현 → 리팩토링 사이클
```

---

## 🗺️ TDD 기반 개발 로드맵

### Phase 1: SMS 시스템 완성 (TDD)
**목표**: Twilio 연동 SMS 시스템을 TDD로 완전히 구현

#### 1.1 SMS 발송 시스템 (TDD)
```
1. 테스트 작성
   - SmsService 단위 테스트 (발송 성공/실패 시나리오)
   - TwilioSmsProvider 테스트 (Mock API 응답)
   - SmsController API 테스트

2. 구현
   - TwilioConfig 설정
   - SmsService 비즈니스 로직
   - TwilioSmsProvider (Infrastructure Layer)
   - SmsApiController (Presentation Layer)

3. 리팩토링
   - 코드 품질 개선
   - 예외 처리 강화
   - 성능 최적화
```

#### 1.2 SMS 수신 웹훅 처리 (TDD)
```
1. 테스트 작성
   - 웹훅 Controller 테스트 (Twilio 서명 검증)
   - SMS 수신 메시지 파싱 테스트
   - 수신 메시지 저장 테스트

2. 구현
   - Twilio Webhook Controller
   - 서명 검증 로직
   - 수신 메시지 처리 Service

3. 리팩토리
   - 보안 검증 강화
   - 에러 핸들링 개선
```

#### 1.3 SMS 이력 관리 시스템 (TDD)
```
1. 테스트 작성
   - SmsHistoryService 테스트
   - 발송 상태 업데이트 테스트
   - 재시도 로직 테스트

2. 구현
   - 발송 실패 재시도 메커니즘
   - 발송 상태 추적
   - 이력 조회 API

3. 리팩토링
   - 성능 최적화
   - 대용량 데이터 처리
```

**Phase 1 완료 기준**:
- 모든 테스트 통과 (커버리지 90% 이상)
- SMS 발송/수신 전체 플로우 완전 동작
- Twilio 연동 안정성 확보

### Phase 2: AI 대화 시스템 구축 (TDD)

#### 2.1 AI 대화 기본 시스템 (TDD)
```
1. 테스트 작성
   - OpenAI GPT-4o API 연동 테스트
   - ConversationService 단위 테스트
   - 대화 맥락 관리 테스트

2. 구현
   - OpenAI API 클라이언트
   - Conversation/Message 엔티티
   - 대화 처리 Service
   - AI 응답 생성 로직

3. 리팩토링
   - API 호출 최적화
   - 토큰 사용량 관리
   - 응답 품질 필터링
```

#### 2.2 대화 맥락 관리 (TDD)
```
1. 테스트 작성
   - 대화 히스토리 관리 테스트
   - 맥락 요약 테스트
   - 장기 기억 테스트

2. 구현
   - ConversationContext 시스템
   - 대화 요약 알고리즘
   - Redis 기반 빠른 맥락 조회

3. 리팩토링
   - 메모리 사용량 최적화
   - 맥락 품질 개선
```

#### 2.3 SMS ↔ AI 통합 플로우 (TDD)
```
1. 테스트 작성
   - SMS 수신 → AI 응답 → SMS 발송 통합 테스트
   - 비동기 처리 테스트
   - 에러 상황 통합 테스트

2. 구현
   - 통합 워크플로우 서비스
   - 비동기 메시지 처리
   - 장애 복구 메커니즘

3. 리팩토링
   - 성능 병목 해결
   - 확장성 개선
```

**Phase 2 완료 기준**:
- SMS 수신 → AI 분석 → SMS 응답 전체 플로우 완전 동작
- 대화 맥락 유지되는 연속 대화 가능
- 모든 테스트 통과 (커버리지 90% 이상)

### Phase 3: 핵심 비즈니스 로직 구현 (TDD)

#### 3.1 정기 안부 메시지 시스템 (TDD)
```
1. 테스트 작성
   - Spring Scheduler 테스트
   - 대량 발송 성능 테스트
   - 발송 실패 처리 테스트

2. 구현
   - @Scheduled 안부 메시지 작업
   - 사용자별 맞춤 메시지 생성
   - 배치 처리 시스템

3. 리팩토링
   - 성능 최적화
   - 장애 복구 강화
```

#### 3.2 감정 분석 및 이상징후 감지 (TDD)
```
1. 테스트 작성
   - 감정 분석 알고리즘 테스트
   - 위험도 점수 계산 테스트
   - 이상징후 감지 테스트

2. 구현
   - GPT-4o 기반 감정 분석
   - 위험도 점수 시스템
   - HealthMonitoring 도메인

3. 리팩토링
   - 분석 정확도 개선
   - 성능 최적화
```

#### 3.3 보호자 알림 시스템 (TDD)
```
1. 테스트 작성
   - Guardian 엔티티 테스트
   - 알림 발송 로직 테스트
   - 에스컬레이션 테스트

2. 구현
   - Guardian 도메인 모델
   - 다채널 알림 시스템
   - 긴급도별 처리

3. 리팩토링
   - 알림 정확도 개선
   - 성능 최적화
```

**Phase 3 완료 기준**:
- 완전한 노인 돌봄 서비스 워크플로우 구현
- 이상징후 감지 시 보호자 알림까지 전체 연결
- 모든 핵심 기능 테스트 커버리지 90% 이상

### Phase 4: 관리 시스템 및 고도화 (TDD)

#### 4.1 관리자 API 시스템 (TDD)
```
1. 테스트 작성
   - 관리자 권한 테스트
   - 대시보드 API 테스트
   - 통계 데이터 테스트

2. 구현
   - Admin 전용 Controller
   - 모니터링 API
   - 통계 및 리포팅 API

3. 리팩토링
   - 권한 시스템 강화
   - API 성능 최적화
```

#### 4.2 성능 및 확장성 개선 (TDD)
```
1. 테스트 작성
   - 부하 테스트
   - 동시성 테스트  
   - 메모리 누수 테스트

2. 구현
   - 캐싱 전략 고도화
   - DB 쿼리 최적화
   - 비동기 처리 개선

3. 리팩토링
   - 아키텍처 최적화
   - 코드 품질 개선
```

**Phase 4 완료 기준**:
- 상용 서비스 수준의 안정성과 성능
- 전체 시스템 테스트 커버리지 85% 이상
- 로컬 개발 환경 완전 구축 완료

---

## 📋 TDD 개발 원칙

### 1. Red-Green-Refactor 사이클 엄수
```
🔴 Red: 실패하는 테스트 먼저 작성
🟢 Green: 테스트를 통과하는 최소한의 코드 작성  
🔵 Refactor: 코드 품질 개선 (테스트는 여전히 통과)
```

### 2. 테스트 작성 우선순위
```
1. 도메인 로직 단위 테스트 (가장 중요)
2. Repository 계층 테스트
3. Service 계층 테스트  
4. Controller 통합 테스트
5. End-to-End 테스트
```

### 3. 테스트 품질 기준
```
- 테스트 커버리지: 90% 이상 (도메인별)
- 테스트 독립성: 각 테스트는 완전히 독립적
- 테스트 속도: 전체 테스트 실행 5분 이내
- 테스트 가독성: Given-When-Then 패턴 사용
```

### 4. Mock 사용 전략
```
- 외부 API (Twilio, OpenAI): Mock 처리
- 데이터베이스: 실제 TestContainer 사용
- Service 간 의존성: Mock 최소화, 실제 객체 선호
```

---

## 🎯 각 Phase별 성공 지표

### Phase 1 (SMS 시스템)
- [ ] SMS 발송 성공률 99% 이상
- [ ] 웹훅 처리 응답시간 500ms 이내
- [ ] SMS 도메인 테스트 커버리지 90% 이상

### Phase 2 (AI 대화 시스템)
- [ ] AI 응답 생성 시간 5초 이내
- [ ] 대화 맥락 유지율 95% 이상
- [ ] AI 도메인 테스트 커버리지 90% 이상

### Phase 3 (핵심 비즈니스)
- [ ] 정기 메시지 발송 성공률 98% 이상
- [ ] 이상징후 감지 정확도 85% 이상
- [ ] 보호자 알림 전달률 99% 이상

### Phase 4 (시스템 고도화)
- [ ] 동시 사용자 1000명 처리 가능
- [ ] API 응답시간 평균 200ms 이내
- [ ] 전체 시스템 테스트 커버리지 85% 이상

---

## 🚨 TDD 개발 시 주의사항

### 기술적 주의점
- **Over-Engineering 방지**: 테스트를 통과하는 최소한의 코드만 작성
- **Mock 의존성 주의**: 너무 많은 Mock은 테스트의 신뢰성 하락
- **외부 API 테스트**: 실제 API 호출은 통합 테스트에서만, 단위 테스트는 Mock 사용

### 프로젝트 관리
- **테스트 우선 문화**: 모든 기능은 반드시 테스트부터 시작
- **리팩토링 주기**: 각 기능 완성 후 반드시 리팩토링 수행
- **코드 리뷰**: 테스트 코드도 프로덕션 코드와 동일한 수준으로 리뷰

---

## 📝 다음 단계 액션 아이템

### 즉시 진행
1. **Twilio API 키 발급 및 환경 설정**
2. **OpenAI GPT-4o API 키 발급**
3. **SMS Domain 테스트 코드 작성 시작 (TDD Red 단계)**
4. **Twilio Java SDK 의존성 추가**

### 준비 작업
1. **TDD 개발 환경 설정 완료**
2. **Test Profile 설정 점검**
3. **Mock 서버 환경 구축 (외부 API 테스트용)**
4. **테스트 데이터 준비 (TestContainer 활용)**

---

*이 개발 계획서는 TDD 기반으로 진행되며, 각 기능의 테스트 완료 후 다음 단계로 진행합니다. 모든 기능은 테스트 우선 개발 원칙을 철저히 준수합니다.*

**문서 생성일**: 2025-09-12  
**최종 수정일**: 2025-09-12  
**버전**: v1.0
**개발 방법론**: Test-Driven Development (TDD)